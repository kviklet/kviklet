databaseChangeLog:
  - changeSet:
      id: 036-migrate-review-config-to-groups
      author: DerkSchooltink
      changes:
        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              -- Migrate legacy review_config JSON from {"numTotalRequired": N}
              -- to {"groupConfigs":[{"roleId":"*","numRequired":N}]}
             UPDATE connection
             SET review_config = CASE
                        WHEN jsonb_exists(review_config::jsonb, 'groupConfigs') THEN review_config
                        ELSE (jsonb_build_object('groupConfigs',
                                                 jsonb_build_array(
                                                         jsonb_build_object('roleId', '*', 'numRequired',
                                                                            COALESCE((review_config::jsonb ->> 'numTotalRequired')::int, 0))))::json
                            ) END;
      rollback:
        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              -- Roll back review_config JSON from groupConfigs format
              -- back to the legacy {"numTotalRequired": N} format.
              --
              -- Note: if multiple groups exist, this rollback collapses them
              -- by summing all numRequired values into a single numTotalRequired.
              UPDATE connection
              SET review_config = CASE
                        WHEN jsonb_exists(review_config::jsonb, 'groupConfigs') AND NOT jsonb_exists(review_config::jsonb, 'numTotalRequired')
                            THEN (
                            jsonb_build_object(
                                    'numTotalRequired',
                                    COALESCE(
                                            (SELECT SUM((elem ->> 'numRequired')::int)
                                             FROM jsonb_array_elements(review_config::jsonb -> 'groupConfigs') elem),
                                            0
                                    )
                            )::json)
                        ELSE review_config
              END;
